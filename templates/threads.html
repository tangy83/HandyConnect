{% extends "base.html" %}

{% block title %}Email Threads - HandyConnect{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Email Threads</h1>
            <div>
                <button class="btn btn-success" onclick="refreshThreads()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Threads
                </button>
            </div>
        </div>

        <!-- Thread Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="active-threads">{{ threads|selectattr('status', 'equalto', 'Active')|list|length }}</h4>
                                <p class="mb-0">Active Threads</p>
                            </div>
                            <i class="bi bi-chat-square-dots fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="pending-threads">{{ threads|selectattr('status', 'equalto', 'Pending')|list|length }}</h4>
                                <p class="mb-0">Pending Threads</p>
                            </div>
                            <i class="bi bi-clock fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="resolved-threads">{{ threads|selectattr('status', 'equalto', 'Resolved')|list|length }}</h4>
                                <p class="mb-0">Resolved Threads</p>
                            </div>
                            <i class="bi bi-check-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Thread Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">Thread Management <span class="badge bg-secondary" id="thread-count">{{ threads|length }}</span></h5>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-success btn-sm" onclick="refreshThreads()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportThreads()">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showThreadAnalytics()">
                                <i class="bi bi-graph-up"></i> Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Sorting Controls -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="sortThreads('created_at')">
                            <i class="bi bi-sort-down" id="thread-sort-newest-icon"></i> Newest
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="sortThreads('priority')">
                            <i class="bi bi-sort-up" id="thread-sort-priority-icon"></i> Priority
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="sortThreads('status')">
                            <i class="bi bi-sort-alpha-down" id="thread-sort-status-icon"></i> Status
                        </button>
                    </div>
                    <div class="text-muted small">
                        <span id="threads-count">{{ threads|length }}</span> threads
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="thread-status-filter">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Pending">Pending</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="thread-priority-filter">
                            <option value="">All Priorities</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="thread-category-filter">
                            <option value="">All Categories</option>
                            <option value="Technical Issue">Technical Issue</option>
                            <option value="Billing Question">Billing Question</option>
                            <option value="Feature Request">Feature Request</option>
                            <option value="Complaint">Complaint</option>
                            <option value="General Inquiry">General Inquiry</option>
                            <option value="Account Issue">Account Issue</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" id="thread-search-input" placeholder="Search threads...">
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="mergeSelectedThreads()">
                                <i class="bi bi-arrow-down-up"></i> Merge
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="bulkUpdateThreadStatus()">
                                <i class="bi bi-check-circle"></i> Update Status
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteThreads()">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Operations Toolbar -->
                <div class="row mt-3" id="thread-bulk-operations" style="display: none;">
                    <div class="col-12">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted">Selected: <span id="selected-thread-count">0</span> threads</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="bulkUpdateThreadStatus()">
                                <i class="bi bi-check-circle"></i> Update Status
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="bulkUpdateThreadPriority()">
                                <i class="bi bi-flag"></i> Update Priority
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="mergeSelectedThreads()">
                                <i class="bi bi-arrow-down-up"></i> Merge Threads
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="bulkDeleteThreads()">
                                <i class="bi bi-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearThreadSelection()">
                                <i class="bi bi-x"></i> Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Threads List -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all-threads" onchange="toggleAllThreads()">
                                </th>
                                <th>Subject</th>
                                <th>Participants</th>
                                <th>Messages</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="threads-table-body">
                            {% for thread in threads %}
                            <tr data-thread-id="{{ thread.id }}" 
                                data-status="{{ thread.status }}" 
                                data-priority="{{ thread.priority }}"
                                onclick="handleThreadRowClick(event, '{{ thread.id }}')"
                                class="thread-row"
                                style="cursor: pointer;">
                                <td>
                                    <input type="checkbox" class="thread-checkbox" value="{{ thread.id }}">
                                </td>
                                <td>
                                    <strong>{{ thread.subject }}</strong>
                                    {% if thread.summary %}
                                    <br><small class="text-muted">{{ thread.summary[:100] }}...</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        {% for participant in thread.participants[:3] %}
                                        <small>{{ participant.name }} ({{ participant.email }})</small>
                                        {% endfor %}
                                        {% if thread.participants|length > 3 %}
                                        <small class="text-muted">+{{ thread.participants|length - 3 }} more</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ thread.message_count }}</span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if thread.priority == 'Urgent' %}bg-danger
                                        {% elif thread.priority == 'High' %}bg-warning
                                        {% elif thread.priority == 'Medium' %}bg-info
                                        {% else %}bg-secondary{% endif %}">
                                        {{ thread.priority }}
                                    </span>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm thread-status-select" 
                                            data-thread-id="{{ thread.id }}">
                                        <option value="Active" {% if thread.status == 'Active' %}selected{% endif %}>Active</option>
                                        <option value="Pending" {% if thread.status == 'Pending' %}selected{% endif %}>Pending</option>
                                        <option value="Resolved" {% if thread.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                                        <option value="Closed" {% if thread.status == 'Closed' %}selected{% endif %}>Closed</option>
                                    </select>
                                </td>
                                <td>
                                    <small>{{ thread.last_activity if thread.last_activity else 'N/A' }}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="viewThread({{ thread.id }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="viewThreadAnalytics({{ thread.id }})">
                                        <i class="bi bi-graph-up"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteThread({{ thread.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="d-flex align-items-center">
                        <div class="text-muted me-3">
                            Showing <span id="showing-thread-start">1</span> to <span id="showing-thread-end">{{ threads|length }}</span> 
                            of <span id="total-thread-count">{{ threads|length }}</span> threads
                        </div>
                        <label for="page-size-select" class="form-label me-2 mb-0">Show:</label>
                        <select class="form-select form-select-sm" id="page-size-select" style="width: auto;" onchange="changePageSize()">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="ms-2 text-muted">per page</span>
                    </div>
                    <nav aria-label="Thread pagination">
                        <ul class="pagination pagination-sm mb-0" id="thread-pagination-controls">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" onclick="changeThreadPage('first')">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" onclick="changeThreadPage('prev')">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#" onclick="changeThreadPage(1)">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" onclick="changeThreadPage('next')">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" onclick="changeThreadPage('last')">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Thread Detail Modal -->
<div class="modal fade" id="threadModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-chat-dots"></i> Thread Details
                    <span class="badge bg-secondary ms-2" id="modal-thread-id">#0</span>
                </h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editThread()">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteThreadFromModal()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" id="threadModalBody">
                <!-- Thread details will be loaded here -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Thread Messages</h6>
                            </div>
                            <div class="card-body" id="thread-messages">
                                <!-- Messages will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Add Message</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Message</label>
                                    <textarea class="form-control" id="new-message" rows="3" placeholder="Type your message..."></textarea>
                                </div>
                                <button class="btn btn-primary" onclick="addMessage()">
                                    <i class="bi bi-send"></i> Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Thread Information</h6>
                            </div>
                            <div class="card-body" id="thread-info">
                                <!-- Thread info will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="modal-status-select">
                                        <option value="Active">Active</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Resolved">Resolved</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="modal-priority-select">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="modal-category-select">
                                        <option value="Technical Issue">Technical Issue</option>
                                        <option value="Billing Question">Billing Question</option>
                                        <option value="Feature Request">Feature Request</option>
                                        <option value="Complaint">Complaint</option>
                                        <option value="General Inquiry">General Inquiry</option>
                                        <option value="Account Issue">Account Issue</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Assigned To</label>
                                    <input type="text" class="form-control" id="modal-assigned-to" placeholder="Enter assignee">
                                </div>
                                
                                <button class="btn btn-primary w-100" onclick="saveThreadChanges()">
                                    <i class="bi bi-check"></i> Save Changes
                                </button>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Participants</h6>
                            </div>
                            <div class="card-body" id="thread-participants">
                                <!-- Participants will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thread Merge Modal -->
<div class="modal fade" id="mergeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-down-up"></i> Merge Threads
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="merge-form">
                    <div class="mb-3">
                        <label class="form-label">Threads to Merge</label>
                        <ul class="list-group" id="merge-thread-list">
                            <!-- Selected threads will be listed here -->
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Target Thread (keep this one)</label>
                        <select class="form-select" id="target-thread-id" required>
                            <option value="">Select target thread...</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Merge Notes</label>
                        <textarea class="form-control" id="merge-notes" rows="3" placeholder="Add notes about this merge..."></textarea>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone. All messages from the source threads will be moved to the target thread.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmMerge()">
                    <i class="bi bi-arrow-down-up"></i> Merge Threads
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Thread Analytics Modal -->
<div class="modal fade" id="threadAnalyticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-graph-up"></i> Thread Analytics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="threadAnalyticsModalBody">
                <!-- Analytics will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Thread-specific JavaScript functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize thread management
    initializeThreadManagement();
    initializeThreadFilters();
});

// Utility function for date formatting
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return dateString; // Return original string if not a valid date
        }
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateString; // Return original string if parsing fails
    }
}

// Utility functions for badge classes
function getStatusBadgeClass(status) {
    switch (status) {
        case 'Active': return 'bg-success';
        case 'Pending': return 'bg-warning';
        case 'Resolved': return 'bg-info';
        case 'Closed': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function getPriorityBadgeClass(priority) {
    switch (priority) {
        case 'Urgent': return 'bg-danger';
        case 'High': return 'bg-warning';
        case 'Medium': return 'bg-info';
        case 'Low': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function initializeThreadManagement() {
    // Status change handlers
    document.querySelectorAll('.thread-status-select').forEach(select => {
        select.addEventListener('change', function() {
            updateThreadStatus(this.dataset.threadId, this.value);
        });
    });
}

function initializeThreadFilters() {
    // Filter event listeners
    const filters = ['thread-status-filter', 'thread-priority-filter', 'thread-search-input'];
    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.addEventListener('change', filterThreads);
            element.addEventListener('input', filterThreads);
        }
    });
}

function filterThreads() {
    const statusFilter = document.getElementById('thread-status-filter')?.value || '';
    const priorityFilter = document.getElementById('thread-priority-filter')?.value || '';
    const searchFilter = document.getElementById('thread-search-input')?.value.toLowerCase() || '';
    
    const rows = document.querySelectorAll('#threads-table-body tr');
    
    rows.forEach(row => {
        const status = row.dataset.status || '';
        const priority = row.dataset.priority || '';
        const text = row.textContent.toLowerCase();
        
        const statusMatch = !statusFilter || status === statusFilter;
        const priorityMatch = !priorityFilter || priority === priorityFilter;
        const searchMatch = !searchFilter || text.includes(searchFilter);
        
        if (statusMatch && priorityMatch && searchMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    updateThreadCounts();
}

function updateThreadCounts() {
    const visibleRows = document.querySelectorAll('#threads-table-body tr[style=""]');
    const totalVisible = visibleRows.length;
    
    // Update visible thread count
    const totalElement = document.getElementById('total-threads');
    if (totalElement) {
        totalElement.textContent = totalVisible;
    }
}

async function updateThreadStatus(threadId, newStatus) {
    try {
        showLoadingIndicator();
        
        const response = await fetch(`/api/threads/${threadId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        const result = await response.json();
        
        if (result && result.status === 'success') {
            // Update the row with animation
            const row = document.querySelector(`tr[data-thread-id="${threadId}"]`);
            if (row) {
                row.classList.add('task-updated');
                row.dataset.status = newStatus;
                
                // Update status select
                const statusSelect = row.querySelector('.thread-status-select');
                if (statusSelect) {
                    statusSelect.value = newStatus;
                }
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    row.classList.remove('task-updated');
                }, 1000);
            }
            
            showNotification('Thread status updated successfully', 'success');
            updateThreadCounts();
        } else {
            showNotification('Failed to update thread status', 'error');
        }
    } catch (error) {
        console.error('Error updating thread status:', error);
        showNotification('Error updating thread status', 'error');
    } finally {
        hideLoadingIndicator();
    }
}

async function viewThread(threadId) {
    try {
        showLoadingIndicator();
        
        const response = await fetch(`/api/threads/${threadId}`);
        const result = await response.json();
        
        if (result && result.status === 'success') {
            displayThreadModal(result.data);
        } else {
            showNotification('Failed to load thread details', 'error');
        }
    } catch (error) {
        console.error('Error loading thread:', error);
        showNotification('Error loading thread details', 'error');
    } finally {
        hideLoadingIndicator();
    }
}

function displayThreadModal(thread) {
    const modalBody = document.getElementById('threadModalBody');
    if (!modalBody) return;
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h6 class="text-muted">Thread Messages</h6>
                <div class="thread-messages" style="max-height: 500px; overflow-y: auto;">
                    ${thread.messages ? thread.messages.map(message => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <strong>${message.sender_name || 'Unknown'}</strong>
                                    <small class="text-muted">${formatDate(message.timestamp)}</small>
                                </div>
                                <p class="mt-2">${message.content || 'No content'}</p>
                            </div>
                        </div>
                    `).join('') : '<p>No messages available</p>'}
                </div>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Thread Details</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>ID:</strong></td>
                        <td>${thread.id}</td>
                    </tr>
                    <tr>
                        <td><strong>Subject:</strong></td>
                        <td>${thread.subject || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td><span class="badge ${getStatusBadgeClass(thread.status)}">${thread.status || 'N/A'}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Priority:</strong></td>
                        <td><span class="badge ${getPriorityBadgeClass(thread.priority)}">${thread.priority || 'N/A'}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Messages:</strong></td>
                        <td>${thread.message_count || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Created:</strong></td>
                        <td>${formatDate(thread.created_at)}</td>
                    </tr>
                    <tr>
                        <td><strong>Last Activity:</strong></td>
                        <td>${formatDate(thread.last_activity)}</td>
                    </tr>
                </table>
                
                <h6 class="text-muted mt-3">Participants</h6>
                <div class="participants-list">
                    ${thread.participants ? thread.participants.map(participant => `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>${participant.name}</span>
                            <small class="text-muted">${participant.email}</small>
                        </div>
                    `).join('') : '<p>No participants</p>'}
                </div>
            </div>
        </div>
    `;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('threadModal'));
    modal.show();
}

async function viewThreadAnalytics(threadId) {
    try {
        showLoadingIndicator();
        
        const response = await fetch(`/api/threads/${threadId}/analytics`);
        const result = await response.json();
        
        if (result && result.status === 'success') {
            displayThreadAnalyticsModal(result.data);
        } else {
            showNotification('Failed to load thread analytics', 'error');
        }
    } catch (error) {
        console.error('Error loading thread analytics:', error);
        showNotification('Error loading thread analytics', 'error');
    } finally {
        hideLoadingIndicator();
    }
}

function displayThreadAnalyticsModal(analytics) {
    const modalBody = document.getElementById('threadAnalyticsModalBody');
    if (!modalBody) return;
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Response Time Metrics</h6>
                <p><strong>Average Response Time:</strong> ${analytics.avg_response_time || 'N/A'}</p>
                <p><strong>First Response Time:</strong> ${analytics.first_response_time || 'N/A'}</p>
                <p><strong>Resolution Time:</strong> ${analytics.resolution_time || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Engagement Metrics</h6>
                <p><strong>Message Count:</strong> ${analytics.message_count || 0}</p>
                <p><strong>Participant Count:</strong> ${analytics.participant_count || 0}</p>
                <p><strong>Activity Score:</strong> ${analytics.activity_score || 'N/A'}</p>
            </div>
        </div>
    `;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('threadAnalyticsModal'));
    modal.show();
}

function toggleAllThreads() {
    const selectAll = document.getElementById('select-all-threads');
    const checkboxes = document.querySelectorAll('.thread-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function mergeSelectedThreads() {
    const selectedThreads = Array.from(document.querySelectorAll('.thread-checkbox:checked'))
        .map(checkbox => checkbox.value);
    
    if (selectedThreads.length < 2) {
        showNotification('Please select at least 2 threads to merge', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to merge ${selectedThreads.length} threads?`)) {
        showNotification('Thread merging functionality coming soon!', 'info');
    }
}

async function deleteThread(threadId) {
    if (!confirm('Are you sure you want to delete this thread?')) {
        return;
    }
    
    try {
        showLoadingIndicator();
        
        const response = await fetch(`/api/threads/${threadId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        
        if (result && result.status === 'success') {
            // Remove the row from the table
            const row = document.querySelector(`tr[data-thread-id="${threadId}"]`);
            if (row) {
                row.remove();
            }
            
            showNotification('Thread deleted successfully', 'success');
            updateThreadCounts();
        } else {
            showNotification('Failed to delete thread', 'error');
        }
    } catch (error) {
        console.error('Error deleting thread:', error);
        showNotification('Error deleting thread', 'error');
    } finally {
        hideLoadingIndicator();
    }
}

async function refreshThreads() {
    try {
        showLoadingIndicator();
        showNotification('Refreshing threads...', 'info');
        
        // Reload the page to refresh threads
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } catch (error) {
        console.error('Error refreshing threads:', error);
        showNotification('Error refreshing threads', 'error');
    } finally {
        hideLoadingIndicator();
    }
    }
</script>

<!-- Thread Management JavaScript -->
<script src="{{ url_for('static', filename='js/thread-management.js') }}"></script>
{% endblock %}
